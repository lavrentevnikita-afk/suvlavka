# Архитектура и деплой проекта

Проект **Souvenir Shop** — интернет‑магазин сувениров с B2C и B2B‑функциональностью, складским учётом и PWA‑поддержкой.  
Все роли работают на одном домене, интерфейс и данные различаются по ролям.

---

## 1. Технологический стек

### Frontend

- **Nuxt 3 (Vue 3, TypeScript)** — SSR/SPA, маршрутизация, мета‑данные, PWA.
- **Pinia** — управление состоянием (корзина, пользователь, фильтры и т.д.).
- **TailwindCSS** — реализация дизайн‑системы через токены и utility‑классы.
- **PWA (@vite-pwa/nuxt)** — офлайн‑кеш, установка как приложение, управление сервис‑воркерами.
- **Storybook** (планируется) — витрина UI‑компонентов.
- **Vitest + Playwright** (планируется) — модульные и e2e‑тесты.

### Backend

- **NestJS (Node.js + TypeScript)** — модульный backend с DI, guards, pipes, фильтрами.
- **PostgreSQL** — основная реляционная БД (товары, категории, пользователи, заказы, склады).
- **Redis** — кэш и фоновые очереди.
- **Локальное файловое хранилище** (`uploads/`) — изображения товаров и вспомогательные файлы
  с возможностью переноса на внешнее/сетевое хранилище без изменения публичных URL.

### Инфраструктура

- **Docker + docker-compose** — единая среда для dev/stage.
- **CI/CD (GitHub Actions / GitLab CI)** — линт, тесты, сборка, деплой.
- **CDN** (на следующих этапах) — для статики и изображений.
- **Meilisearch / OpenSearch** (позже) — для расширенного поиска и фильтрации.

---

## 2. Высокоуровневая структура

```text
souvenir-shop/
├── frontend/        # Nuxt 3 PWA (Vue 3 + TS + Tailwind + Pinia)
├── backend/         # NestJS (TS) API
├── uploads/         # локальное хранилище изображений
├── docker-compose.yml
└── документация и служебные файлы
```

### Основные компоненты

1. **Frontend (Nuxt 3 PWA)**  
   - публичный каталог (B2C),
   - личные кабинеты (розница и магазины),
   - интерфейсы менеджеров и администраторов,
   - мобильный UI и PWA‑функциональность.

2. **Backend API (NestJS)**  
   Модули:
   - `Auth` — аутентификация, роли пользователей;
   - `Users` — пользователи и магазины;
   - `Catalog` — категории, товары, изображения и цены;
   - `Orders` — заказы, корзины, статусы, платежная логика (позже);
   - `Warehouse` — склады, остатки, движения;
   - `B2B` — функциональность оптовых клиентов;
   - `Reports` — аналитика и отчёты.

3. **База данных (PostgreSQL)**  
   - пользователи, роли и магазины;
   - товары, категории, цены;
   - заказы и позиции заказов;
   - склады, остатки, движения;
   - задачи производства и отгрузки;
   - события и логи.

4. **Redis**  
   - кэш «горячих» данных каталога;
   - сессии/блокировки (при необходимости);
   - очереди фоновых задач (уведомления, импорты, генерация отчётов).

5. **Файловое хранилище (локально)**  
   - каталог `uploads/` на сервере;
   - структура вида `uploads/products/<product_id>/image_<n>.jpg`;
   - отдача файлов через backend или reverse‑proxy (Nginx);
   - дальнейший перенос на внешнее хранилище: либо через монтиирование (NAS), либо через S3‑совместимый сервис.

---

## 3. Роли и доступ

Все пользователи работают на одном домене. Доступ к данным и действиям регулируется на уровне backend (NestJS guards + проверки ролей).

Роли:

- **Guest** — гость:
  - видит каталог и карточки товаров,
  - формирует гостевую корзину.

- **Retail** — розничный покупатель:
  - видит розничные цены,
  - имеет личный кабинет и историю заказов.

- **Store** — магазин (B2B):
  - видит индивидуальные/оптовые цены,
  - пользуется быстрым заказом и шаблонами,
  - имеет B2B‑отчёты.

- **Manager** — менеджер:
  - обрабатывает все заказы,
  - управляет их статусами,
  - взаимодействует со складом и производством.

- **Admin** — администратор:
  - управляет пользователями, ролями и магазинами,
  - ведёт каталог, ценообразование, складские настройки,
  - просматривает и настраивает отчёты.

---

## 4. Паттерны взаимодействия

### Потоки данных

1. Пользователь открывает страницу → запрос попадает на Nuxt SSR‑сервер.
2. Nuxt:
   - рендерит HTML на сервере,
   - по мере необходимости обращается к NestJS API.
3. NestJS:
   - читает данные из PostgreSQL,
   - при необходимости использует Redis для кэша,
   - возвращает JSON‑ответ.
4. Клиентская часть Nuxt гидратируется и продолжает работать как SPA.

### Работа с изображениями

- Ссылки на изображения имеют стабильный вид (`/media/products/...`).
- На старте URL маппятся на локальную директорию `uploads/`.
- В дальнейшем путь может быть перекинут на:
  - внешнее хранилище,
  - CDN,
  - либо их комбинацию — при этом публичные URL остаются прежними.

---

## 5. Окружения

Рекомендуемые окружения:

- `local` — локальная разработка;
- `dev` / `stage` — тестовые стенды;
- `prod` — боевое окружение.

Переменные окружения (общая идея):

Frontend:
- `NUXT_PUBLIC_API_BASE_URL`
- `NUXT_PUBLIC_APP_NAME`
- `NUXT_PUBLIC_PWA_ENABLED`

Backend:
- `DATABASE_URL`
- `REDIS_URL`
- `JWT_SECRET`
- `PORT`
- `UPLOADS_DIR`

---

## 6. Docker и orkструирование

Используется `docker-compose` для локальной разработки и, при желании, для dev/stage:

Сервисы:
- `frontend` — Nuxt dev/prod,
- `backend` — NestJS,
- `db` — PostgreSQL,
- `redis` — Redis.

---

## 7. Масштабирование

Стартовая конфигурация — один инстанс frontend и backend, одиночные Postgres и Redis.  

Пути роста:

- горизонтальное масштабирование Nuxt и NestJS за балансировщиком;
- выделение реплик БД (read‑replica для аналитики);
- разнесение Redis на отдельный кластер;
- вынос изображений на выделенное хранилище + CDN;
- вынос поиска в отдельный сервис (Meilisearch / OpenSearch).

---
